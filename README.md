# Far_Test
Данный проект выполнялся в рамках тестового задания на прохождение летней практики в vl.ru с использованием Symfony, Docker, nginx и MySQL. В рамках задания был реализован микросервис, распределяющий процессы между машинами и производящий их ребалансировку с учетом MVC паттерна и принципов SOLID.

## Развёртывание

1.  **Соберите образы и запустите контейнеры в фоновом режиме:**
    `docker compose up -d`

2.  **Установите зависимости:**
    `docker compose exec php83-service composer install`

3.  **Создайте новую миграцию на основе изменений в модели данных внутри контейнера:**
    `docker compose exec php83-service php bin/console make:migration --no-interaction`

4.  **Примените миграции к основной базе данных:**
    `docker compose exec php83-service php bin/console doctrine:migrations:migrate --no-interaction`

5.  **Примените миграции к тестовой базе данных:**
    `docker compose exec php83-service php bin/console doctrine:migrations:migrate --env=test --no-interaction`

6.  **Запустите тесты внутри контейнера:**
    `docker compose run --rm php83-service php vendor/bin/phpunit`
    
## Документация API

1.  **Получение связей:**
    URL: `/assignments`  
    Метод: `GET`
    Возвращает список всех связей, где каждое назначение содержит:
    - `id` — уникальный идентификатор связи
    - `machineId` — идентификатор машины, на которую назначен процесс
    - `processId` — идентификатор процесса

2. **Получение списка машин:**

    URL: `/machines`
    Метод: `GET`
    Описание: Возвращает список всех машин, каждая из которых содержит:
    - `id` — уникальный идентификатор машины
    - `totalMemory` — общее количество оперативной памяти машины
    - `totalCpu` — общее количество процессорных ядер на машине

3. **Получение списка процессов:**

    URL: `/processes`
    Метод: `GET`
    Описание: Возвращает список всех процессов, каждый из которых содержит:
    - `id` — уникальный идентификатор процесса
    - `requiredMemory` — количество оперативной памяти, необходимое для запуска процесса
    - ` requiredCpu` — количество процессорных ядер, необходимых для выполнения процесса


4.  **Добавление процесса:**
    URL: `/process/add  `
    Метод: `POST`
    Создаёт новый процесс с указанными ресурсными требованиями и пытается назначить его на подходящую машину.  
    Если подходящая машина не найдена или отсутствуют обязательные данные, возвращается сообщение об ошибке.
    ### Тело запроса
    - Content-Type: application/json
    - Параметры:
    - `requiredMemory` (integer) — требуемая память для процесса
    - `requiredCpu` (integer) — требуемый объём CPU для процесса

5.  **Удаление процесса:**
    URL: `/process/delete/{id}` 
    Метод: `DELETE`
    Удаляет процесс по его идентификатору. Если у процесса есть назначение, оно также удаляется. После удаления вызывается процедура перераспределения назначений.
    ### Параметры пути
    - `id` (integer) — идентификатор процесса, который необходимо удалить

6.  **Добавление машины:**
    URL: `/machine/add`  
    Метод: `POST`
    Создаёт новую машину с заданными ресурсами и вызывает перераспределение назначений для перераспределения процессов между машинами.
    ### Тело запроса
    - Content-Type: application/json
    - Параметры:
    - `totalMemory` (integer) — общий объём памяти машины
    - `totalCpu` (integer) — общее количество CPU машины

7.  **Удаление машины:**
    URL: `/machine/delete/{id}` 
    Метод: `DELETE`
    Удаляет машину по её идентификатору. Все назначения, связанные с этой машиной, удаляются, а процессы перераспределяются на другие подходящие машины.
    ### Параметры пути
    - `id` (integer) — идентификатор машины, которую необходимо удалить

## Вспомогательные методы (не являются публичными API)

1.  **findSuitableMachine**
    Определяет подходящую машину для размещения процесса, учитывая требования по памяти и CPU, а также исключая указанную машину (если требуется).
    Параметры:
    - `ProcessEntity` $process
    - `EntityManagerInterface` $em
    - `Machine`|null $excludeMachine (опционально)
    Возвращает:  
    Объект Machine или null, если подходящая машина не найдена.

2.  **rebalance**
    Перераспределяет все назначения. Удаляет текущие назначения, сортирует процессы по сумме требуемых ресурсов и заново распределяет их по машинам с наименьшей относительной нагрузкой.
    Параметры:
    - `EntityManagerInterface` $em
    Возвращает:  
    Ничего (void).
